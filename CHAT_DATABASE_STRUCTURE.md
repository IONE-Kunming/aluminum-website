# Chat Database Structure

This document describes the correct structure for the chat system in Firestore after collections have been deleted and recreated.

## Collections

### 1. `chats` Collection

Stores chat conversation metadata between two users.

**Document ID Format**: `{userId1}_{userId2}` (sorted alphabetically)
- Example: `abc123_xyz789` where `abc123` < `xyz789` in lexicographic order

**Required Fields**:
```javascript
{
  participants: [userId1, userId2],        // Array of user IDs
  lastMessage: string,                     // Preview of last message
  lastMessageTime: timestamp,              // Firestore server timestamp
  lastSenderId: string,                    // ID of user who sent last message
  buyerId: string,                         // ID of buyer in conversation
  sellerId: string                         // ID of seller in conversation
}
```

**Firestore Index**:
```json
{
  "fields": [
    { "fieldPath": "participants", "arrayConfig": "CONTAINS" },
    { "fieldPath": "lastMessageTime", "order": "DESCENDING" }
  ]
}
```

**Query Pattern**:
```javascript
db.collection('chats')
  .where('participants', 'array-contains', userId)
  .orderBy('lastMessageTime', 'desc')
```

---

### 2. `messages` Collection

Stores individual chat messages.

**Document ID**: Auto-generated by Firestore

**Required Fields**:
```javascript
{
  chatId: string,              // Format: {userId1}_{userId2} (sorted)
  senderId: string,            // User ID of sender
  receiverId: string,          // User ID of receiver
  senderName: string,          // Display name of sender
  message: string,             // Message text content
  originalLanguage: string,    // Language code (e.g., 'en', 'zh')
  attachments: array,          // Array of attachment objects
  read: boolean,               // Whether message has been read
  createdAt: timestamp         // Firestore server timestamp
}
```

**Attachment Object Structure**:
```javascript
{
  name: string,        // Original file name
  url: string,         // Download URL from Firebase Storage
  type: string,        // MIME type (e.g., 'image/jpeg')
  size: number,        // File size in bytes
  path: string         // Storage path
}
```

**Firestore Index**:
```json
{
  "fields": [
    { "fieldPath": "chatId", "order": "ASCENDING" },
    { "fieldPath": "createdAt", "order": "ASCENDING" }
  ]
}
```

**Query Pattern**:
```javascript
db.collection('messages')
  .where('chatId', '==', chatId)
  .orderBy('createdAt', 'asc')
```

---

## Code Implementation

### Creating a Chat

When a user sends their first message to another user:

1. Generate `chatId` using sorted user IDs: `[userId1, userId2].sort().join('_')`
2. Create message document in `messages` collection
3. Create/update chat document in `chats` collection using `set(..., { merge: true })`
4. Create notification for receiver

### Subscribing to Messages

**Buyer Chat** (`dataService.subscribeToChatMessages`):
```javascript
await dataService.subscribeToChatMessages(sellerId, (messages) => {
  // Handle messages array
});
```

**Seller Chat** (`dataService.subscribeToSellerChatMessages`):
```javascript
await dataService.subscribeToSellerChatMessages(buyerId, (messages) => {
  // Handle messages array
});
```

Both subscriptions:
- Use the composite index for optimal performance
- Return messages sorted by `createdAt` ascending
- Automatically mark received messages as read after 1 second delay
- Handle real-time updates via Firestore snapshots

### Sending Messages

**Buyer Sending** (`dataService.sendChatMessage`):
```javascript
await dataService.sendChatMessage({
  sellerId: 'seller-user-id',
  message: 'Hello',
  files: [] // Optional file attachments
});
```

**Seller Sending** (`dataService.sendSellerChatMessage`):
```javascript
await dataService.sendSellerChatMessage({
  buyerId: 'buyer-user-id',
  message: 'Hello',
  files: [] // Optional file attachments
});
```

---

## Security Rules

### Chats Collection

```javascript
match /chats/{chatId} {
  // Participants can read their own chats
  allow read: if isAuthenticated() && 
                 request.auth.uid in resource.data.participants;
  // Users can create chats
  allow create: if isAuthenticated() && 
                   request.auth.uid in request.resource.data.participants;
  // Participants can update chat (last message, etc.)
  allow update: if isAuthenticated() && 
                   request.auth.uid in resource.data.participants;
}
```

### Messages Collection

```javascript
match /messages/{messageId} {
  // Participants can read messages in their chats
  allow read: if isAuthenticated() && 
                 (request.auth.uid == resource.data.senderId || 
                  request.auth.uid == resource.data.receiverId);
  // Users can send messages
  allow create: if isAuthenticated() && 
                   request.resource.data.senderId == request.auth.uid;
  // Users can update messages (mark as read)
  allow update: if isAuthenticated() && 
                   (request.auth.uid == resource.data.senderId || 
                    request.auth.uid == resource.data.receiverId);
}
```

---

## Important Notes

1. **ChatId Consistency**: Always generate chatId using `[userId1, userId2].sort().join('_')` to ensure consistency between buyer and seller views.

2. **Index Usage**: The composite indexes are critical for query performance. Queries use `.orderBy()` to leverage these indexes.

3. **Mark as Read**: Both buyer and seller subscriptions implement a 1-second debounced mark-as-read to avoid excessive database writes.

4. **File Storage**: Chat attachments are stored in Firebase Storage at path `chats/{chatId}/{timestamp}_{filename}`.

5. **Optimistic UI**: Chat pages implement optimistic UI updates - messages appear instantly before Firebase confirms, with a 5-second timeout fallback.

6. **Translation Support**: Messages include `originalLanguage` field for automatic translation feature between users speaking different languages.

---

## Deployment Checklist

After deleting collections, ensure:

- [x] Firestore indexes are deployed (`firebase deploy --only firestore:indexes`)
- [x] Firestore rules are deployed (`firebase deploy --only firestore:rules`)
- [x] Application code uses `.orderBy('createdAt', 'asc')` in message queries
- [x] Both buyer and seller subscriptions have mark-as-read logic
- [x] ChatId generation is consistent across all functions

---

## Troubleshooting

**Messages not appearing in conversations:**
1. Check browser console for errors
2. Verify chatId is being generated correctly (sorted user IDs)
3. Ensure Firestore indexes are deployed and built (can take several minutes)
4. Verify Firestore rules allow read access
5. Check that `createdAt` timestamp is being set properly

**Queries timing out or slow:**
1. Ensure composite indexes are deployed
2. Verify queries include `.orderBy('createdAt', 'asc')`
3. Check Firestore console for index build status

**Messages not marked as read:**
1. Verify user has read/update permission in Firestore rules
2. Check that receiverId matches current user
3. Look for batch commit errors in console
