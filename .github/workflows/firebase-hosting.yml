# .github/workflows/firebase-hosting.yml
name: Deploy to Firebase

on:
  # Runs on pushes targeting the main branch
  push:
    branches: ["main"]
    paths:
      - 'public/**'
      - 'index.html'
      - 'vite.config.js'
      - 'package.json'
      - 'package-lock.json'
      - 'firebase.json'
      - 'firestore.rules'
      - 'firestore.indexes.json'
      - 'storage.rules'
      - '.github/workflows/firebase-hosting.yml'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build with Vite
        run: npm run build
        env:
          # Firebase uses root path (not /aluminum-website/ like GitHub Pages)
          VITE_BASE_PATH: /
          
      - name: Create Firebase Service Account Key
        run: |
          # Create service account file from GitHub Secret
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > firebase-service-account.json
          # Validate JSON format
          jq . firebase-service-account.json > /dev/null
          echo "âœ… Service account key created"
          
      - name: Setup Firebase Project
        env:
          GOOGLE_APPLICATION_CREDENTIALS: firebase-service-account.json
        run: |
          # Install Firebase CLI
          npm install -g firebase-tools@latest
          
          # Set the Firebase project
          firebase use gen-lang-client-0988357303 --alias default
          
          # Verify project setup
          echo "Current Firebase project:"
          firebase projects:list | grep gen-lang-client-0988357303
          
          # Ensure firebase.json exists with correct structure
          if [ ! -f "firebase.json" ]; then
            echo "Creating firebase.json..."
            cat > firebase.json << 'EOF'
{
  "firestore": {
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  },
  "storage": {
    "rules": "storage.rules"
  },
  "hosting": {
    "public": "dist",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      {
        "source": "**",
        "destination": "/index.html"
      }
    ]
  }
}
EOF
          fi
          
          # Ensure .firebaserc exists
          if [ ! -f ".firebaserc" ]; then
            echo "Creating .firebaserc..."
            cat > .firebaserc << 'EOF'
{
  "projects": {
    "default": "gen-lang-client-0988357303"
  }
}
EOF
          fi
          
          # Create default config files if missing
          [ ! -f "firestore.rules" ] && echo 'rules_version = "2"; service cloud.firestore { match /databases/{database}/documents { match /{document=**} { allow read, write: if true; } } }' > firestore.rules
          [ ! -f "firestore.indexes.json" ] && echo '{"indexes":[],"fieldOverrides":[]}' > firestore.indexes.json
          [ ! -f "storage.rules" ] && echo 'rules_version = "2"; service firebase.storage { match /b/{bucket}/o { match /{allPaths=**} { allow read, write: if true; } } }' > storage.rules
          
      - name: Deploy to Firebase
        env:
          GOOGLE_APPLICATION_CREDENTIALS: firebase-service-account.json
        run: |
          echo "ğŸš€ Starting Firebase deployment..."
          
          # Deploy step by step with error handling
          echo "ğŸ“ Deploying Firestore rules..."
          if [ -f "firestore.rules" ]; then
            firebase deploy --only firestore:rules --non-interactive || echo "âš ï¸  Firestore rules deployment had issues"
          fi
          
          echo "ğŸ“Š Deploying Firestore indexes..."
          if [ -f "firestore.indexes.json" ]; then
            firebase deploy --only firestore:indexes --non-interactive || echo "âš ï¸  Firestore indexes deployment had issues"
          fi
          
          echo "ğŸ“¦ Deploying Storage rules..."
          if [ -f "storage.rules" ]; then
            firebase deploy --only storage --non-interactive || echo "âš ï¸  Storage rules deployment had issues"
          fi
          
          echo "ğŸŒ Deploying Hosting..."
          if [ -d "dist" ]; then
            firebase deploy --only hosting --non-interactive
          else
            echo "âŒ No dist/ directory found - checking build output..."
            ls -la
            exit 1
          fi
          
          echo "âœ… Deployment completed successfully!"
