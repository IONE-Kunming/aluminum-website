# .github/workflows/firebase-hosting.yml
name: Deploy to Firebase

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build with Vite
        run: npm run build
        
      - name: Setup Firebase CLI
        run: |
          # Install without deprecated warnings
          npm install -g firebase-tools@latest --quiet
          firebase --version
          
      - name: Create and Validate Service Account Key
        run: |
          # Create service account file from GitHub Secret
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > service-account.json
          
          # Validate JSON format
          if ! python3 -m json.tool service-account.json > /dev/null 2>&1; then
            echo "‚ùå Invalid JSON in FIREBASE_SERVICE_ACCOUNT secret"
            echo "First 100 chars of secret:"
            echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' | head -c 100
            exit 1
          fi
          
          echo "‚úÖ Service account key created and validated"
          ls -la service-account.json
          
      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          token_format: 'access_token'
          
      - name: Deploy to Firebase
        env:
          GOOGLE_APPLICATION_CREDENTIALS: service-account.json
        run: |
          echo "üöÄ Starting Firebase deployment..."
          
          # Set Firebase project
          firebase use gen-lang-client-0988357303 --alias default
          
          # Deploy everything
          firebase deploy --project gen-lang-client-0988357303 --non-interactive
          
          echo "‚úÖ Deployment completed successfully!"
